<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Champions â€” ChampsDual</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{--gold:#C8AA6E;--gold-l:#F0E6D3;--gold-d:#785A28;--deep:#010A13;--mid:#0A1628;--ok:#2ecc71;--bad:#e74c3c;--warn:#f39c12;}
body{background:var(--deep);color:var(--gold-l);font-family:'Cinzel',serif;min-height:100vh;overflow-x:hidden;-webkit-user-select:none;user-select:none;}
input{-webkit-user-select:text;user-select:text;}
img{-webkit-user-drag:none;pointer-events:none;}
.bg-layer{position:fixed;inset:0;z-index:0;}
.bg-g{background:radial-gradient(ellipse 80% 50% at 50% 0%,#0d1f3c 0%,transparent 60%),var(--deep);}
.bg-h{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='70'%3E%3Cpolygon points='30,2 58,17 58,52 30,67 2,52 2,17' fill='none' stroke='%23C8AA6E' stroke-width='0.3' opacity='0.08'/%3E%3C/svg%3E");background-size:60px 70px;}
.corner{position:fixed;width:80px;height:80px;z-index:2;opacity:.4;}
.c-tl{top:0;left:0;border-top:2px solid var(--gold);border-left:2px solid var(--gold);}
.c-tr{top:0;right:0;border-top:2px solid var(--gold);border-right:2px solid var(--gold);}
.c-bl{bottom:0;left:0;border-bottom:2px solid var(--gold);border-left:2px solid var(--gold);}
.c-br{bottom:0;right:0;border-bottom:2px solid var(--gold);border-right:2px solid var(--gold);}

/* SCREENS */
.screen{position:relative;z-index:10;display:none;}
.screen.active{display:flex;flex-direction:column;}
@keyframes fadeUp{from{opacity:0;transform:translateY(16px);}to{opacity:1;transform:translateY(0);}}

/* SHARED COMPONENTS */
.field-label{font-size:.5rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.55;display:block;margin-bottom:.4rem;}
.txt-input{width:100%;padding:.75rem 1rem;background:rgba(10,22,40,.9);border:1px solid var(--gold-d);color:var(--gold-l);font-family:'Cinzel',serif;font-size:.82rem;letter-spacing:.08em;outline:none;transition:border-color .2s;-webkit-user-select:text;user-select:text;}
.txt-input:focus{border-color:var(--gold);}
.txt-input::placeholder{color:rgba(200,170,110,.22);}
.gold-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;width:100%;padding:.88rem;background:transparent;border:none;cursor:pointer;font-family:'Cinzel',serif;font-size:.78rem;font-weight:600;letter-spacing:.25em;text-transform:uppercase;color:var(--deep);clip-path:polygon(10px 0%,calc(100% - 10px) 0%,100% 50%,calc(100% - 10px) 100%,10px 100%,0% 50%);transition:transform .2s,filter .2s;margin-top:.65rem;}
.gold-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,#F0E6D3 0%,#C8AA6E 50%,#A17D3A 100%);z-index:-1;}
.gold-btn:hover{transform:scale(1.02);filter:brightness(1.1);}
.gold-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;filter:none;}
.ghost-btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:.72rem;background:transparent;border:1px solid var(--gold-d);cursor:pointer;font-family:'Cinzel',serif;font-size:.72rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);transition:border-color .2s,background .2s;margin-top:.45rem;}
.ghost-btn:hover{border-color:var(--gold);background:rgba(200,170,110,.06);}
.err-msg{font-size:.62rem;color:var(--bad);min-height:1.2rem;margin-top:.4rem;letter-spacing:.04em;}

/* LOADING */
.loading{position:fixed;inset:0;z-index:60;background:var(--deep);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;transition:opacity .5s;}
.loading.hidden{opacity:0;pointer-events:none;}
.ld-title{font-family:'Cinzel Decorative',serif;font-size:1.5rem;background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.ld-bar-w{width:200px;height:2px;background:rgba(200,170,110,.2);overflow:hidden;}
.ld-bar{width:100%;height:100%;background:linear-gradient(to right,transparent,var(--gold),transparent);animation:scan 1.2s ease-in-out infinite;}
@keyframes scan{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
.ld-txt{font-size:.6rem;letter-spacing:.3em;color:var(--gold);opacity:.5;text-transform:uppercase;}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(80px);z-index:40;background:rgba(8,20,40,.96);border:1px solid var(--gold-d);padding:.55rem 1.5rem;font-size:.68rem;letter-spacing:.1em;color:var(--gold-l);text-align:center;transition:transform .3s,opacity .3s;opacity:0;max-width:90vw;pointer-events:none;}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1;}

/* SDOT */
.sdot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.sdot.connected{background:var(--ok);box-shadow:0 0 4px var(--ok);}
.sdot.disconnected{background:var(--bad);}
.sdot.connecting{background:var(--warn);animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
.sstat{display:inline-flex;align-items:center;gap:.4rem;font-size:.5rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:.6;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-setup{min-height:100vh;align-items:center;justify-content:center;padding:2rem;}
.setup-box{border:1px solid var(--gold-d);padding:2.5rem;background:linear-gradient(135deg,#0a1628,#010a13);position:relative;max-width:560px;width:100%;text-align:center;}
.setup-box::before{content:'';position:absolute;top:-2px;left:-2px;width:25px;height:25px;border:2px solid var(--gold);border-right:none;border-bottom:none;}
.setup-box::after{content:'';position:absolute;bottom:-2px;right:-2px;width:25px;height:25px;border:2px solid var(--gold);border-left:none;border-top:none;}
.setup-icon{font-size:2.5rem;margin-bottom:.75rem;}
.setup-title{font-family:'Cinzel Decorative',serif;font-size:1.3rem;background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.4rem;}
.setup-sub{font-size:.58rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.5;margin-bottom:2rem;}
.steps{text-align:left;display:flex;flex-direction:column;gap:.6rem;margin-bottom:2rem;}
.step{display:flex;gap:.75rem;}
.step-num{font-family:'Cinzel Decorative',serif;font-size:.9rem;color:var(--gold);min-width:1.4rem;padding-top:.05rem;}
.step-txt{font-size:.66rem;line-height:1.7;color:var(--gold-l);opacity:.75;}
.step-txt a{color:var(--gold);text-decoration:none;border-bottom:1px solid rgba(200,170,110,.3);}
.step-txt code{background:rgba(200,170,110,.1);padding:.1rem .3rem;font-family:monospace;font-size:.75rem;color:var(--gold-l);letter-spacing:0;border-radius:2px;}
.step-txt b{color:var(--gold-l);opacity:1;}
.skip-link{font-size:.52rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:.35;background:none;border:none;cursor:pointer;font-family:'Cinzel',serif;transition:opacity .2s;display:block;margin-top:1rem;}
.skip-link:hover{opacity:.85;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-lobby{min-height:100vh;align-items:center;justify-content:center;padding:2rem;}
.lobby-header{text-align:center;margin-bottom:2.5rem;animation:fadeUp .6s ease forwards;opacity:0;}
.lobby-icon{font-size:2.8rem;margin-bottom:.6rem;}
.lobby-title{font-family:'Cinzel Decorative',serif;font-size:clamp(1.4rem,4vw,2.2rem);background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.35rem;}
.lobby-sub{font-size:.58rem;letter-spacing:.4em;text-transform:uppercase;color:var(--gold);opacity:.5;}
.lobby-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:1.25rem;width:min(960px,92vw);animation:fadeUp .6s ease forwards .2s;opacity:0;}
@media(max-width:680px){.lobby-cards{grid-template-columns:1fr;}}
@media(max-width:900px) and (min-width:681px){.lobby-cards{grid-template-columns:1fr 1fr;}}
.mcard{position:relative;background:linear-gradient(160deg,rgba(15,30,55,.9),rgba(5,12,25,.95));border:1px solid var(--gold-d);padding:2rem 1.75rem 1.75rem;display:flex;flex-direction:column;gap:.9rem;transition:transform .25s,border-color .25s,box-shadow .25s;overflow:hidden;}
.mcard::before,.mcard::after{content:'';position:absolute;width:18px;height:18px;border-color:var(--gold);border-style:solid;}
.mcard::before{top:-1px;left:-1px;border-width:2px 0 0 2px;}
.mcard::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0;}
.mcard:hover{transform:translateY(-4px);border-color:var(--gold);box-shadow:0 0 25px rgba(200,170,110,.1),0 15px 35px rgba(0,0,0,.4);}
.mcard-num{font-family:'Cinzel Decorative',serif;font-size:2rem;color:rgba(200,170,110,.07);position:absolute;top:.75rem;right:.9rem;line-height:1;}
.mcard-icon{font-size:2rem;line-height:1;}
.mcard-name{font-family:'Cinzel Decorative',serif;font-size:clamp(.9rem,2vw,1.1rem);background:linear-gradient(135deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.mcard-desc{font-size:.65rem;line-height:1.75;color:var(--gold-l);opacity:.55;}
.room-form{display:flex;flex-direction:column;gap:.5rem;margin-top:auto;}
.rdiv{display:flex;align-items:center;gap:.5rem;margin:.25rem 0;}
.rdiv-line{flex:1;height:1px;background:rgba(200,170,110,.12);}
.rdiv-txt{font-size:.44rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.4;}
.lobby-footer{display:flex;align-items:center;justify-content:space-between;width:min(960px,92vw);margin-top:1.5rem;animation:fadeUp .5s ease forwards .35s;opacity:0;}
.back-link{font-size:.55rem;letter-spacing:.22em;text-transform:uppercase;color:var(--gold);opacity:.45;text-decoration:none;transition:opacity .2s;}
.back-link:hover{opacity:.9;}
.reconfig-btn{font-size:.5rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:.3;background:none;border:none;cursor:pointer;font-family:'Cinzel',serif;transition:opacity .2s;}
.reconfig-btn:hover{opacity:.8;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DUEL WAIT ROOM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-duel-wait{min-height:100vh;align-items:center;justify-content:center;padding:2rem;}
.wait-box{border:1px solid var(--gold-d);background:linear-gradient(135deg,#0a1628,#010a13);padding:2rem 2.2rem;width:min(520px,94vw);position:relative;animation:fadeUp .5s ease both;}
.wait-box::before{content:'';position:absolute;top:-2px;left:-2px;width:22px;height:22px;border:2px solid var(--gold);border-right:none;border-bottom:none;}
.wait-box::after{content:'';position:absolute;bottom:-2px;right:-2px;width:22px;height:22px;border:2px solid var(--gold);border-left:none;border-top:none;}
.wait-title{font-family:'Cinzel Decorative',serif;font-size:1.25rem;background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-align:center;margin-bottom:.25rem;}
.wait-sub{font-size:.48rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.45;text-align:center;margin-bottom:1.2rem;}
.wait-code-row{display:flex;align-items:center;justify-content:center;gap:.75rem;margin-bottom:1.2rem;}
.wait-code{font-family:'Cinzel Decorative',serif;font-size:1.8rem;letter-spacing:.3em;color:var(--gold);filter:drop-shadow(0 0 10px rgba(200,170,110,.5));}
.copy-btn{font-size:.44rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:.45;background:none;border:1px solid rgba(200,170,110,.25);cursor:pointer;padding:.22rem .5rem;font-family:'Cinzel',serif;transition:opacity .2s,border-color .2s;}
.copy-btn:hover{opacity:.9;border-color:var(--gold);}
.wp-label{font-size:.44rem;letter-spacing:.33em;text-transform:uppercase;color:var(--gold);opacity:.5;margin-bottom:.5rem;}
.wp-list{display:flex;flex-direction:column;gap:.35rem;min-height:50px;margin-bottom:1.1rem;}
.wp-row{display:flex;align-items:center;justify-content:space-between;padding:.4rem .7rem;background:rgba(200,170,110,.04);border:1px solid rgba(200,170,110,.09);}
.wp-name{font-size:.65rem;letter-spacing:.06em;}
.wp-name.me::after{content:' (vous)';font-size:.5rem;color:var(--gold);opacity:.5;}
.wp-badge{font-size:.44rem;letter-spacing:.15em;text-transform:uppercase;padding:.16rem .45rem;border-radius:2px;}
.wp-badge.ready{background:rgba(46,204,113,.15);color:var(--ok);border:1px solid rgba(46,204,113,.3);}
.wp-badge.waiting{background:rgba(200,170,110,.07);color:var(--gold);opacity:.5;border:1px solid rgba(200,170,110,.15);}
/* Options */
.opts-title{font-size:.46rem;letter-spacing:.32em;text-transform:uppercase;color:var(--gold);opacity:.5;margin-bottom:.7rem;}
.opts-block{border-top:1px solid rgba(200,170,110,.12);padding-top:1rem;margin-bottom:1rem;}
.opt-row{display:flex;align-items:center;gap:.75rem;margin-bottom:.72rem;}
.opt-label{font-size:.6rem;letter-spacing:.05em;color:var(--gold-l);opacity:.7;flex:1;}
.opt-val{font-family:'Cinzel Decorative',serif;font-size:.8rem;color:var(--gold);min-width:3.5rem;text-align:right;flex-shrink:0;}
input[type=range]{-webkit-appearance:none;appearance:none;flex:1;height:3px;background:rgba(200,170,110,.2);border-radius:2px;outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--gold);box-shadow:0 0 6px rgba(200,170,110,.5);cursor:pointer;}
.toggle-row{display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:.6rem;}
.toggle-label{font-size:.6rem;letter-spacing:.05em;color:var(--gold-l);opacity:.7;}
.toggle{position:relative;width:36px;height:20px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.ttrack{position:absolute;inset:0;background:rgba(200,170,110,.15);border:1px solid var(--gold-d);border-radius:10px;cursor:pointer;transition:background .2s,border-color .2s;}
.toggle input:checked+.ttrack{background:rgba(200,170,110,.35);border-color:var(--gold);}
.tthumb{position:absolute;top:2px;left:2px;width:14px;height:14px;background:var(--gold-d);border-radius:50%;transition:transform .2s,background .2s;pointer-events:none;}
.toggle input:checked~.tthumb{transform:translateX(16px);background:var(--gold);}
.sub-opts{padding-left:.5rem;border-left:2px solid rgba(200,170,110,.15);margin-top:.4rem;margin-bottom:.4rem;}
.sub-opts.hidden{display:none;}
.opts-ro{font-size:.58rem;color:var(--gold);opacity:.5;letter-spacing:.06em;border-top:1px solid rgba(200,170,110,.12);padding-top:1rem;margin-bottom:1rem;}
.wait-auto{font-size:.5rem;letter-spacing:.15em;text-transform:uppercase;color:var(--gold);opacity:.4;text-align:center;margin-top:.4rem;}
.wait-tv{color:var(--gold);font-family:'Cinzel Decorative',serif;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COOP / SOLO GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-game{min-height:100vh;align-items:stretch;}
.game-header{position:sticky;top:0;z-index:20;width:100%;background:rgba(1,10,19,.96);backdrop-filter:blur(10px);border-bottom:1px solid rgba(200,170,110,.18);padding:.75rem 1.5rem;display:flex;align-items:center;justify-content:space-between;gap:1rem;flex-wrap:wrap;}
.hdr-left{display:flex;align-items:center;gap:1rem;}
.hdr-mid{flex:1;min-width:200px;max-width:460px;}
.hdr-right{display:flex;align-items:center;gap:1.25rem;flex-wrap:wrap;}
.h-back{font-size:.54rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:.5;text-decoration:none;white-space:nowrap;transition:opacity .2s;background:none;border:none;cursor:pointer;font-family:'Cinzel',serif;}
.h-back:hover{opacity:1;}
.hstat{text-align:center;}
.hstat-lbl{font-size:.42rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.5;display:block;}
.hstat-val{font-size:1rem;color:var(--gold-l);font-weight:600;font-family:'Cinzel Decorative',serif;}
.timer-disp{font-family:'Cinzel Decorative',serif;font-size:1.3rem;background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 6px rgba(200,170,110,.4));}
.room-badge{display:flex;align-items:center;gap:.5rem;border:1px solid var(--gold-d);padding:.28rem .65rem;cursor:pointer;transition:border-color .2s;background:rgba(10,22,40,.6);}
.room-badge:hover{border-color:var(--gold);}
.room-badge-lbl{font-size:.4rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.5;}
.room-badge-code{font-size:.78rem;letter-spacing:.2em;color:var(--gold);font-family:'Cinzel Decorative',serif;}
.room-badge.hidden{display:none;}
.players-bar{display:flex;gap:.45rem;align-items:center;flex-wrap:wrap;}
.plpip{display:flex;align-items:center;gap:.28rem;font-size:.53rem;color:var(--gold-l);opacity:.8;}
.plpipdot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.plpipdot.me{background:var(--gold);}
.plpipdot.other{background:var(--ok);animation:blink 2s infinite;}
.input-bar{display:flex;gap:.5rem;}
.champ-input{flex:1;padding:.55rem .9rem;background:rgba(10,22,40,.9);border:1px solid var(--gold-d);color:var(--gold-l);font-family:'Cinzel',serif;font-size:.82rem;letter-spacing:.06em;outline:none;transition:border-color .3s,box-shadow .3s;min-width:0;-webkit-user-select:text;user-select:text;}
.champ-input:focus{border-color:var(--gold);}
.champ-input::placeholder{color:rgba(200,170,110,.28);}
.champ-input.fc{border-color:var(--ok)!important;box-shadow:0 0 10px rgba(46,204,113,.35);}
.champ-input.fw{border-color:var(--bad)!important;}
.champ-input.fa{border-color:var(--warn)!important;box-shadow:0 0 8px rgba(243,156,18,.3);}
.mini-sub{padding:.55rem 1rem;background:transparent;border:1px solid var(--gold-d);color:var(--gold);font-family:'Cinzel',serif;font-size:.62rem;letter-spacing:.2em;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:border-color .2s,background .2s;}
.mini-sub:hover{border-color:var(--gold);background:rgba(200,170,110,.07);}
.inp-fb{font-size:.58rem;letter-spacing:.15em;text-transform:uppercase;min-height:1rem;color:var(--gold);opacity:.65;padding:.12rem 0;}
.game-body{position:relative;z-index:10;display:flex;flex:1;}
.feed-sidebar{width:205px;min-width:205px;border-right:1px solid rgba(200,170,110,.1);background:rgba(1,10,19,.5);display:flex;flex-direction:column;max-height:calc(100vh - 64px);position:sticky;top:64px;align-self:flex-start;}
.feed-title{font-size:.46rem;letter-spacing:.35em;text-transform:uppercase;color:var(--gold);opacity:.5;padding:.6rem 1rem;border-bottom:1px solid rgba(200,170,110,.08);}
.feed-list{flex:1;overflow-y:auto;padding:.35rem;}
.feed-list::-webkit-scrollbar{width:3px;}
.feed-list::-webkit-scrollbar-thumb{background:var(--gold-d);}
.fi{display:flex;align-items:center;gap:.4rem;padding:.28rem .4rem;animation:feedIn .3s ease;margin-bottom:.15rem;}
@keyframes feedIn{from{opacity:0;transform:translateX(-8px);}to{opacity:1;}}
.fi-img{width:26px;height:26px;border-radius:50%;border:1px solid var(--gold-d);object-fit:cover;flex-shrink:0;}
.fi-txt{font-size:.54rem;line-height:1.45;color:var(--gold-l);opacity:.8;min-width:0;overflow:hidden;}
.fi-player{color:var(--gold);font-weight:600;}
.fi-time{font-size:.45rem;color:var(--gold);opacity:.4;margin-left:auto;white-space:nowrap;}
.grid-area{flex:1;padding:1.25rem;overflow-y:auto;}
.prog-row{display:flex;align-items:center;gap:1rem;margin-bottom:1.25rem;}
.prog-bg{flex:1;height:3px;background:rgba(200,170,110,.12);}
.prog-fill{height:100%;background:linear-gradient(to right,var(--gold-d),var(--gold));transition:width .5s ease;}
.prog-txt{font-size:.52rem;letter-spacing:.28em;text-transform:uppercase;color:var(--gold);opacity:.55;white-space:nowrap;}
.champ-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(66px,1fr));gap:.55rem;}
.ctile{position:relative;aspect-ratio:1;border:1px solid rgba(200,170,110,.17);background:rgba(8,18,32,.85);overflow:hidden;transition:border-color .3s;}
.ctile img{width:100%;height:100%;object-fit:cover;display:block;opacity:0;transition:opacity .4s;}
.ctile.found img{opacity:1;}
.ctile-ov{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(1,10,19,.8);transition:opacity .4s;pointer-events:none;}
.ctile.found .ctile-ov{opacity:0;}
.ctile-q{font-family:'Cinzel Decorative',serif;font-size:1.2rem;color:rgba(200,170,110,.2);}
.ctile-name{position:absolute;bottom:0;left:0;right:0;font-size:.35rem;letter-spacing:.04em;text-align:center;padding:.15rem .1rem;background:rgba(1,10,19,.88);color:var(--gold);opacity:0;transition:opacity .3s;text-transform:uppercase;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ctile.found .ctile-name{opacity:1;}
.ctile-finder{position:absolute;top:2px;left:0;right:0;font-size:.32rem;text-align:center;background:rgba(1,10,19,.72);padding:1px;color:var(--gold-l);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0;transition:opacity .3s;}
.ctile.found .ctile-finder{opacity:.7;}
.ctile.found{border-color:rgba(200,170,110,.5);animation:tileReveal .45s ease;}
.ctile.found.byme{border-color:var(--ok);}
.ctile-finder.byme{color:var(--ok);}
@keyframes tileReveal{0%{transform:scale(.78);filter:brightness(2.5);}100%{transform:scale(1);filter:brightness(1);}}
.victory{position:fixed;inset:0;z-index:50;background:rgba(1,10,19,.97);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .5s;}
.victory.show{opacity:1;pointer-events:all;}
.vic-box{text-align:center;border:1px solid var(--gold-d);padding:2.5rem 3.5rem;background:linear-gradient(135deg,#0a1628,#010a13);position:relative;max-width:500px;width:90%;}
.vic-box::before{content:'';position:absolute;top:-2px;left:-2px;width:25px;height:25px;border:2px solid var(--gold);border-right:none;border-bottom:none;}
.vic-box::after{content:'';position:absolute;bottom:-2px;right:-2px;width:25px;height:25px;border:2px solid var(--gold);border-left:none;border-top:none;}
.vic-title{font-family:'Cinzel Decorative',serif;font-size:1.8rem;background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.4rem;}
.vic-sub{font-size:.58rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.55;margin-bottom:1.5rem;}
.vic-time{font-family:'Cinzel Decorative',serif;font-size:2.5rem;color:var(--gold);filter:drop-shadow(0 0 12px rgba(200,170,110,.6));margin-bottom:.3rem;}
.vic-lbl{font-size:.55rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.45;margin-bottom:1.5rem;}
.scores{border:1px solid var(--gold-d);padding:.75rem 1rem;margin-bottom:1.5rem;text-align:left;}
.sc-row{display:flex;justify-content:space-between;align-items:center;padding:.25rem 0;border-bottom:1px solid rgba(200,170,110,.07);}
.sc-row:last-child{border-bottom:none;}
.sc-name{font-size:.68rem;letter-spacing:.06em;color:var(--gold-l);}
.sc-pts{font-size:.85rem;font-family:'Cinzel Decorative',serif;color:var(--gold);}
@media(max-width:680px){.feed-sidebar{display:none;}.champ-grid{grid-template-columns:repeat(auto-fill,minmax(52px,1fr));}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DUEL GAME SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-duel{min-height:100vh;display:flex;flex-direction:column;}
.duel-topbar{position:sticky;top:0;z-index:20;background:rgba(1,10,19,.96);backdrop-filter:blur(10px);border-bottom:1px solid rgba(200,170,110,.15);padding:.45rem 1.25rem;display:flex;align-items:center;gap:1rem;height:50px;}
.duel-timer{font-family:'Cinzel Decorative',serif;font-size:1.15rem;color:var(--gold);filter:drop-shadow(0 0 6px rgba(200,170,110,.4));white-space:nowrap;min-width:4rem;}
.duel-timer.danger{color:var(--bad);filter:drop-shadow(0 0 8px rgba(231,76,60,.6));animation:tpulse .5s infinite;}
@keyframes tpulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.duel-vs-bar{flex:1;display:flex;align-items:center;justify-content:center;gap:1.25rem;}
.dph{text-align:center;}
.dph-name{font-size:.52rem;letter-spacing:.15em;text-transform:uppercase;color:var(--gold-l);opacity:.7;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.dph-name.me{color:var(--gold);}
.dph-score{font-family:'Cinzel Decorative',serif;font-size:1.1rem;color:var(--gold);}
.duel-sep{font-size:.7rem;color:var(--gold);opacity:.4;letter-spacing:.2em;}
.atk-wrap{display:flex;flex-direction:column;align-items:center;gap:2px;}
.atk-lbl{font-size:.38rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:.4;}
.atk-pips{display:flex;gap:2px;}
.atk-pip{width:8px;height:8px;border-radius:2px;border:1px solid rgba(200,170,110,.2);background:rgba(200,170,110,.06);transition:background .2s,border-color .2s;}
.atk-pip.lit{background:var(--bad);border-color:var(--bad);box-shadow:0 0 4px var(--bad);}
.duel-back-btn{font-size:.5rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:.4;background:none;border:none;cursor:pointer;font-family:'Cinzel',serif;white-space:nowrap;transition:opacity .2s;}
.duel-back-btn:hover{opacity:.9;}
/* Duel body: two grids */
.duel-body{flex:1;display:flex;min-height:0;}
.duel-half{flex:1;display:flex;flex-direction:column;border-right:1px solid rgba(200,170,110,.1);overflow:hidden;}
.duel-half:last-child{border-right:none;}
.duel-half-title{font-size:.42rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.5;padding:.4rem .8rem;border-bottom:1px solid rgba(200,170,110,.07);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;}
.duel-half-title.me-side{color:var(--gold);opacity:.85;}
.duel-half-score{font-family:'Cinzel Decorative',serif;font-size:.7rem;color:var(--gold);}
.duel-grid{flex:1;overflow-y:auto;padding:.5rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(42px,1fr));gap:3px;align-content:start;}
.duel-grid::-webkit-scrollbar{width:3px;}
.duel-grid::-webkit-scrollbar-thumb{background:var(--gold-d);}
.dtile{width:42px;height:42px;border:1px solid rgba(200,170,110,.12);position:relative;overflow:hidden;border-radius:2px;flex-shrink:0;}
.dtile img{width:100%;height:100%;object-fit:cover;display:block;}
.dtile .dq{position:absolute;inset:0;background:rgba(8,18,32,.92);border:1px solid rgba(200,170,110,.07);display:flex;align-items:center;justify-content:center;font-size:1rem;color:rgba(200,170,110,.22);transition:opacity .35s;}
.dtile.found .dq{opacity:0;pointer-events:none;}
.dtile.attacked{animation:atkFlash .7s ease;}
@keyframes atkFlash{0%,100%{border-color:rgba(200,170,110,.12);}25%{border-color:var(--bad);box-shadow:0 0 12px var(--bad);}60%{border-color:rgba(231,76,60,.4);}}
/* Input bar */
.duel-input-bar{position:sticky;bottom:0;z-index:18;background:rgba(1,10,19,.96);border-top:1px solid rgba(200,170,110,.12);padding:.55rem 1.25rem;display:flex;gap:.75rem;align-items:center;}
.duel-inp-wrap{flex:1;position:relative;}
.duel-input{width:100%;padding:.62rem 1rem;background:rgba(10,22,40,.9);border:1px solid var(--gold-d);color:var(--gold-l);font-family:'Cinzel',serif;font-size:.8rem;letter-spacing:.08em;outline:none;transition:border-color .2s,box-shadow .2s;-webkit-user-select:text;user-select:text;}
.duel-input:focus{border-color:var(--gold);}
.duel-input::placeholder{color:rgba(200,170,110,.28);}
.duel-input.dfc{border-color:var(--ok)!important;box-shadow:0 0 10px rgba(46,204,113,.3);}
.duel-input.dfw{border-color:var(--bad)!important;animation:dshake .25s ease;}
@keyframes dshake{0%,100%{transform:translateX(0);}30%{transform:translateX(-5px);}70%{transform:translateX(5px);}}
.duel-drop{position:absolute;bottom:100%;left:0;right:0;background:rgba(4,12,26,.98);border:1px solid var(--gold-d);max-height:180px;overflow-y:auto;display:none;z-index:30;}
.duel-drop.open{display:block;}
.dauto-item{padding:.42rem .85rem;font-size:.72rem;letter-spacing:.05em;color:var(--gold-l);cursor:pointer;opacity:.72;transition:background .1s;-webkit-user-select:none;user-select:none;}
.dauto-item:hover,.dauto-item.sel{background:rgba(200,170,110,.12);opacity:1;}
.dauto-item strong{color:var(--gold);}
.duel-found-cnt{font-size:.52rem;letter-spacing:.15em;text-transform:uppercase;color:var(--gold);opacity:.6;white-space:nowrap;}
/* Attack notification */
.atk-notif{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:55;background:rgba(231,76,60,.15);border:2px solid var(--bad);padding:.75rem 1.75rem;font-family:'Cinzel Decorative',serif;font-size:1rem;color:var(--bad);filter:drop-shadow(0 0 14px rgba(231,76,60,.5));pointer-events:none;opacity:0;transition:opacity .3s;text-align:center;}
.atk-notif.show{opacity:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DUEL RESULT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s-duel-result{min-height:100vh;align-items:center;justify-content:center;padding:2rem;}
.res-box{border:1px solid var(--gold-d);background:linear-gradient(135deg,#0a1628,#010a13);padding:2.5rem 3rem;width:min(480px,94vw);position:relative;text-align:center;animation:fadeUp .6s ease both;}
.res-box::before{content:'';position:absolute;top:-2px;left:-2px;width:25px;height:25px;border:2px solid var(--gold);border-right:none;border-bottom:none;}
.res-box::after{content:'';position:absolute;bottom:-2px;right:-2px;width:25px;height:25px;border:2px solid var(--gold);border-left:none;border-top:none;}
.res-title{font-family:'Cinzel Decorative',serif;font-size:1.8rem;background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.25rem;}
.res-sub{font-size:.52rem;letter-spacing:.35em;text-transform:uppercase;color:var(--gold);opacity:.5;margin-bottom:1.75rem;}
.res-scores{display:flex;gap:1rem;justify-content:center;margin-bottom:1.75rem;}
.rsi{border:1px solid var(--gold-d);padding:.75rem 1.25rem;min-width:110px;}
.rsi.winner{border-color:var(--gold);background:rgba(200,170,110,.06);}
.rsi-val{font-family:'Cinzel Decorative',serif;font-size:1.5rem;color:var(--gold);display:block;}
.rsi-name{font-size:.5rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:.55;display:block;margin-top:.2rem;}
.rsi-pts{font-size:.62rem;color:var(--gold-l);opacity:.55;display:block;margin-top:.1rem;}
</style>
</head>
<body>
<div class="bg-layer bg-g"></div>
<div class="bg-layer bg-h"></div>
<div class="corner c-tl"></div><div class="corner c-tr"></div>
<div class="corner c-bl"></div><div class="corner c-br"></div>

<div class="loading" id="loading">
  <div class="ld-title">Champions</div>
  <div class="ld-bar-w"><div class="ld-bar"></div></div>
  <div class="ld-txt" id="ld-txt">Chargement des champions</div>
</div>
<div class="toast" id="toast"></div>

<!-- Attack notification -->
<div class="atk-notif" id="atk-notif">âš”ï¸ ATTAQUE !<br><span style="font-size:.6rem;opacity:.7;">Un de vos champions a Ã©tÃ© masquÃ©</span></div>

<!-- â•â•â• SETUP â•â•â• -->
<div class="screen" id="s-setup">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;">
  <div class="setup-box">
    <div class="setup-icon">ğŸš‚</div>
    <div class="setup-title">Configurer le serveur</div>
    <div class="setup-sub">Railway + Socket.io</div>
    <div class="steps">
      <div class="step"><div class="step-num">1</div><div class="step-txt">CrÃ©ez un compte gratuit sur <a href="https://railway.app" target="_blank">railway.app</a></div></div>
      <div class="step"><div class="step-num">2</div><div class="step-txt">DÃ©ployez depuis GitHub avec les fichiers <code>server.js</code> et <code>package.json</code> fournis</div></div>
      <div class="step"><div class="step-num">3</div><div class="step-txt">Copiez l'URL publique Railway ci-dessous</div></div>
    </div>
    <label class="field-label" for="server-url">URL du serveur Railway</label>
    <input class="txt-input" id="server-url" type="text" placeholder="https://votre-projet.railway.app">
    <div class="err-msg" id="setup-err"></div>
    <button class="gold-btn" onclick="saveServerUrl()">âœ¦ Connecter et continuer</button>
    <button class="skip-link" onclick="skipSetup()">Passer â€” jouer solo uniquement</button>
  </div>
  </div>
</div>

<!-- â•â•â• LOBBY â•â•â• -->
<div class="screen" id="s-lobby">
  <div style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;gap:0;">
  <div class="lobby-header">
    <div class="lobby-icon">âš”ï¸</div>
    <div class="lobby-title">Champions</div>
    <div class="lobby-sub">Retrouvez tous les champions</div>
  </div>
  <div class="lobby-cards">

    <!-- SOLO -->
    <div class="mcard">
      <div class="mcard-num">I</div>
      <div class="mcard-icon">ğŸ¯</div>
      <div class="mcard-name">Solo</div>
      <div class="mcard-desc">Retrouvez seul le nom de tous les champions. Chrono en cours, tolÃ©rance sur les fautes de frappe et de phonÃ©tique.</div>
      <button class="gold-btn" onclick="startSolo()" style="margin-top:auto;">â–¶ Jouer seul</button>
    </div>

    <!-- COOP -->
    <div class="mcard">
      <div class="mcard-num">II</div>
      <div class="mcard-icon">ğŸ‘¥</div>
      <div class="mcard-name">Coop</div>
      <div class="mcard-desc">CrÃ©ez une salle, partagez le lien. Trouvez tous les champions ensemble â€” synchronisation en temps rÃ©el.</div>
      <div class="room-form">
        <div>
          <label class="field-label">Pseudo</label>
          <input class="txt-input" id="player-name" type="text" placeholder="Nom d'invocateur..." maxlength="18">
        </div>
        <div class="sstat"><div class="sdot connecting" id="sdot"></div><span id="stext">Non connectÃ©</span></div>
        <button class="gold-btn" id="create-btn" onclick="createCoopRoom()">âœ¦ CrÃ©er une salle</button>
        <div class="rdiv"><div class="rdiv-line"></div><div class="rdiv-txt">ou rejoindre</div><div class="rdiv-line"></div></div>
        <div>
          <label class="field-label">Code de salle</label>
          <input class="txt-input" id="room-code-input" type="text" placeholder="XXXXXX" maxlength="6" style="text-transform:uppercase;letter-spacing:.35em;">
        </div>
        <button class="ghost-btn" onclick="joinCoopRoom()">Rejoindre â†’</button>
        <div class="err-msg" id="coop-err"></div>
      </div>
    </div>

    <!-- DUEL -->
    <div class="mcard">
      <div class="mcard-num">III</div>
      <div class="mcard-icon">âš”ï¸</div>
      <div class="mcard-name">Duel</div>
      <div class="mcard-desc">2 joueurs, chacun sa grille cachÃ©e. Retrouvez un maximum de champions avant la fin du temps. Mode attaque disponible.</div>
      <div class="room-form">
        <div>
          <label class="field-label">Pseudo</label>
          <input class="txt-input" id="duel-name" type="text" placeholder="Nom d'invocateur..." maxlength="18">
        </div>
        <div class="sstat"><div class="sdot connecting" id="sdot2"></div><span id="stext2">Non connectÃ©</span></div>
        <button class="gold-btn" onclick="createDuelRoom()">âœ¦ CrÃ©er le Duel</button>
        <div class="rdiv"><div class="rdiv-line"></div><div class="rdiv-txt">ou rejoindre</div><div class="rdiv-line"></div></div>
        <div>
          <label class="field-label">Code de salle</label>
          <input class="txt-input" id="duel-code-input" type="text" placeholder="DXXXXX" maxlength="6" style="text-transform:uppercase;letter-spacing:.35em;">
        </div>
        <button class="ghost-btn" onclick="joinDuelRoom()">Rejoindre â†’</button>
        <div class="err-msg" id="duel-err"></div>
      </div>
    </div>
  </div>
  <div class="lobby-footer">
    <a class="back-link" href="index.html">â† Retour Ã  l'accueil</a>
    <button class="reconfig-btn" onclick="showScreen('s-setup')">âš™ Changer l'URL du serveur</button>
  </div>
  </div>
</div>

<!-- â•â•â• DUEL WAIT ROOM â•â•â• -->
<div class="screen" id="s-duel-wait">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;">
  <div class="wait-box">
    <div class="wait-title">Salle Duel</div>
    <div class="wait-sub">âš”ï¸ Grille des Champions</div>
    <div class="wait-code-row">
      <div class="wait-code" id="dw-code">â€”â€”</div>
      <button class="copy-btn" id="dw-copy-btn" onclick="copyDuelLink()">ğŸ“‹ Copier</button>
    </div>
    <div class="wp-label">Joueurs (2 max)</div>
    <div class="wp-list" id="dw-players"></div>

    <!-- OPTIONS â€” host only -->
    <div id="dw-opts" class="opts-block">
      <div class="opts-title">âš™ Options de la partie</div>
      <div class="opt-row">
        <span class="opt-label">DurÃ©e de la partie</span>
        <input type="range" id="opt-dur" min="3" max="30" step="1" value="15" oninput="onOptsChange()">
        <span class="opt-val" id="ov-dur">15 min</span>
      </div>
      <div class="opt-row">
        <span class="opt-label">Champions Ã  trouver</span>
        <input type="range" id="opt-cnt" min="10" max="50" step="5" value="50" oninput="onOptsChange()">
        <span class="opt-val" id="ov-cnt">50</span>
      </div>
      <div class="toggle-row">
        <span class="toggle-label">Mode Attaque</span>
        <label class="toggle">
          <input type="checkbox" id="opt-atk" onchange="onOptsChange()">
          <div class="ttrack"></div>
          <div class="tthumb"></div>
        </label>
      </div>
      <div id="sub-atk" class="sub-opts hidden">
        <div class="opt-row">
          <span class="opt-label">Champions consÃ©cutifs pour dÃ©clencher l'attaque</span>
          <input type="range" id="opt-atkt" min="3" max="10" step="1" value="5" oninput="onOptsChange()">
          <span class="opt-val" id="ov-atkt">5</span>
        </div>
      </div>
    </div>
    <!-- JOINER readonly options -->
    <div id="dw-opts-ro" class="opts-ro hidden"></div>

    <button class="gold-btn" id="dw-ready-btn" onclick="setDuelReady()">âœ¦ Je suis prÃªt !</button>
    <div class="wait-auto" id="dw-auto">DÃ©part dans <span class="wait-tv" id="dw-auto-v">30</span>s si tout le monde est prÃªt ou si inactif</div>
    <div class="err-msg" id="dw-err" style="text-align:center;margin-top:.4rem;"></div>
  </div>
  </div>
</div>

<!-- â•â•â• COOP / SOLO GAME â•â•â• -->
<div class="screen" id="s-game">
  <div class="game-header">
    <div class="hdr-left">
      <button class="h-back" onclick="goLobby()">â† Lobby</button>
      <div class="room-badge hidden" id="room-badge" onclick="copyCoopLink()">
        <div><div class="room-badge-lbl">Salle</div><div class="room-badge-code" id="room-badge-code">â€”â€”</div></div>
        <span style="font-size:.5rem;color:var(--gold);opacity:.4;margin-left:.3rem;">ğŸ“‹</span>
      </div>
    </div>
    <div class="hdr-mid">
      <div class="input-bar">
        <input class="champ-input" id="champ-input" type="text" placeholder="Entrez un nom de champion..." autocomplete="off" autocorrect="off" spellcheck="false">
        <button class="mini-sub" onclick="submitAnswer()">Valider</button>
      </div>
      <div class="inp-fb" id="inp-fb"></div>
    </div>
    <div class="hdr-right">
      <div class="hstat"><span class="hstat-lbl">TrouvÃ©s</span><span class="hstat-val" id="found-count">0</span></div>
      <div class="hstat"><span class="hstat-lbl">Total</span><span class="hstat-val" id="total-count">â€”</span></div>
      <div class="hstat"><span class="hstat-lbl">Chrono</span><span class="timer-disp" id="timer-disp">00:00</span></div>
      <div class="players-bar" id="players-bar"></div>
    </div>
  </div>
  <div class="game-body">
    <div class="feed-sidebar">
      <div class="feed-title">ğŸ† DÃ©couvertes</div>
      <div class="feed-list" id="feed-list"></div>
    </div>
    <div class="grid-area">
      <div class="prog-row">
        <div class="prog-bg"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
        <div class="prog-txt" id="prog-txt">0 / â€” champions</div>
      </div>
      <div class="champ-grid" id="champ-grid"></div>
    </div>
  </div>
</div>
<div class="victory" id="victory">
  <div class="vic-box">
    <div class="vic-title">ğŸ‰ Victoire !</div>
    <div class="vic-sub">Tous les champions trouvÃ©s !</div>
    <div class="vic-time" id="vic-time">00:00</div>
    <div class="vic-lbl">temps total</div>
    <div class="scores" id="vic-scores"></div>
    <button class="gold-btn" onclick="goLobby()" style="margin-bottom:0;">â† Lobby</button>
  </div>
</div>

<!-- â•â•â• DUEL GAME â•â•â• -->
<div class="screen" id="s-duel">
  <div class="duel-topbar">
    <button class="duel-back-btn" onclick="goLobby()">â† Lobby</button>
    <div class="duel-vs-bar">
      <div class="dph">
        <div class="dph-name me" id="dph-me-name">Moi</div>
        <div class="dph-score" id="dph-me-score">0</div>
      </div>
      <div class="atk-wrap" id="atk-wrap" style="display:none;">
        <div class="atk-lbl">âš” Attaque</div>
        <div class="atk-pips" id="atk-pips"></div>
      </div>
      <div class="duel-sep">VS</div>
      <div class="dph">
        <div class="dph-name" id="dph-opp-name">Adversaire</div>
        <div class="dph-score" id="dph-opp-score">0</div>
      </div>
    </div>
    <div class="duel-timer" id="duel-timer">15:00</div>
  </div>

  <div class="duel-body">
    <div class="duel-half">
      <div class="duel-half-title me-side">
        <span id="my-half-title">Ma grille</span>
        <span class="duel-half-score" id="my-half-score">0 / 50</span>
      </div>
      <div class="duel-grid" id="my-grid"></div>
    </div>
    <div class="duel-half">
      <div class="duel-half-title">
        <span id="opp-half-title">Adversaire</span>
        <span class="duel-half-score" id="opp-half-score">0 / 50</span>
      </div>
      <div class="duel-grid" id="opp-grid"></div>
    </div>
  </div>

  <div class="duel-input-bar">
    <div class="duel-inp-wrap">
      <input class="duel-input" id="duel-input" type="text" placeholder="Tapez un nom de champion..." autocomplete="off" autocorrect="off" spellcheck="false">
      <div class="duel-drop" id="duel-drop"></div>
    </div>
    <div class="duel-found-cnt" id="duel-cnt">0 / 50</div>
  </div>
</div>

<!-- â•â•â• DUEL RESULT â•â•â• -->
<div class="screen" id="s-duel-result">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;">
  <div class="res-box">
    <div class="res-title" id="res-title">ğŸ† Victoire !</div>
    <div class="res-sub" id="res-sub">Partie terminÃ©e</div>
    <div class="res-scores" id="res-scores"></div>
    <button class="gold-btn" onclick="replayDuel()">â†º Rejouer</button>
    <button class="ghost-btn" onclick="goLobby()" style="margin-top:.4rem;clip-path:none;">â† Lobby</button>
  </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FUZZY / PHONETIC MATCHING (preserved)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function levenshtein(a,b){const m=a.length,n=b.length;if(!m)return n;if(!n)return m;const row=Array.from({length:n+1},(_,i)=>i);for(let i=1;i<=m;i++){let prev=row[0];row[0]=i;for(let j=1;j<=n;j++){const tmp=row[j];row[j]=a[i-1]===b[j-1]?prev:1+Math.min(prev,row[j],row[j-1]);prev=tmp;}}return row[n];}
function maxDist(len){if(len<=3)return 0;if(len<=5)return 1;if(len<=8)return 2;if(len<=12)return 3;return 4;}
function nb(s){return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');}
function np(s){let r=nb(s);r=r.replace(/ph/g,'f').replace(/ck/g,'k');r=r.replace(/(.)\\1+/g,'$1');r=r.replace(/^h/,'');r=r.replace(/y/g,'i').replace(/w/g,'v');r=r.replace(/eau/g,'o').replace(/ai/g,'e').replace(/ei/g,'e');r=r.replace(/qu/g,'k');return r;}
function fuzzyMatch(input,champName){if(!input||input.length<2)return false;const ni=nb(input),nc=nb(champName);if(ni===nc)return 'exact';const d=levenshtein(ni,nc),mx=maxDist(Math.max(ni.length,nc.length));if(d<=mx)return 'fuzzy';const pi=np(input),pc=np(champName);if(pi===pc)return 'fuzzy';if(levenshtein(pi,pc)<=maxDist(Math.max(pi.length,pc.length)))return 'fuzzy';if(levenshtein('h'+ni,nc)<=mx)return 'fuzzy';if(d<=mx+1||levenshtein(pi,pc)<=maxDist(Math.max(pi.length,pc.length))+1)return 'almost';return false;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA & STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let version='', allChampions=[], champMap={};

// Shared
let socket=null, serverUrl='', mySocketId='', myName='';
const URL_KEY='lol-server-url';

// Coop/Solo
let coopMode='solo', coopRoomCode='', coopStartTime=0;
let timerIntvl=null;
let foundIds=new Set(), events=[], playersList=[];

// Duel
let duelSocket=null;          // reuse same socket
let duelRoomCode='', duelMyName='';
let duelIsOwner=false, duelIsReady=false;
let duelPlayers=[];
let duelOptions={duration:15,champCount:50,attackMode:false,atkThreshold:5};
let autoReadyTimer=null, autoReadySecs=30;
let myFoundSet=new Set(), oppFoundSet=new Set();
let myStreak=0;
let duelTimerInterval=null, duelEndTime=0;
let duelOppName='', duelOppId='';
let duelAtkMode=false, duelAtkThreshold=5, duelChampCount=50;
let duelSelAuto=-1;
let guestId='';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(async function boot(){
  guestId = 'Invocateur' + (1000 + Math.floor(Math.random()*9000));
  try{
    const v = await fetch('https://ddragon.leagueoflegends.com/api/versions.json');
    version = (await v.json())[0];
    const r = await fetch(`https://ddragon.leagueoflegends.com/cdn/${version}/data/fr_FR/champion.json`);
    allChampions = Object.values((await r.json()).data).map(c=>({id:c.id,name:c.name})).sort((a,b)=>a.name.localeCompare(b.name));
    allChampions.forEach(c=>{ champMap[c.id]=c; });
    // Update count slider max
    const maxC = Math.min(allChampions.length, 200);
    document.getElementById('opt-cnt').max = maxC;
    hideLoading();
    const saved = localStorage.getItem(URL_KEY);
    const hash  = location.hash.replace('#','').toUpperCase().trim();
    if(hash.length===6 && !hash.startsWith('D')){
      document.getElementById('room-code-input').value = hash;
    }
    if(hash.length===6 && hash.startsWith('D')){
      document.getElementById('duel-code-input').value = hash;
    }
    if(saved){
      serverUrl=saved;
      document.getElementById('server-url').value=saved;
      connectSocket(saved);
      showScreen('s-lobby');
    } else {
      showScreen('s-setup');
    }
  }catch(e){ document.getElementById('ld-txt').textContent='Erreur rÃ©seau'; }
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOCKET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function connectSocket(url){
  if(socket){ socket.disconnect(); socket=null; }
  setDot('sdot','stext','connecting');
  setDot('sdot2','stext2','connecting');
  try{
    socket = io(url, {transports:['websocket','polling'], timeout:6000});
    socket.on('connect',    ()=>{ mySocketId=socket.id; setDot('sdot','stext','connected'); setDot('sdot2','stext2','connected'); });
    socket.on('disconnect', ()=>{ setDot('sdot','stext','disconnected'); setDot('sdot2','stext2','disconnected'); });
    socket.on('connect_error',()=>{ setDot('sdot','stext','disconnected'); setDot('sdot2','stext2','disconnected'); });
    // Coop events
    socket.on('champFound',   onRemoteFind);
    socket.on('playerJoined', d=>{ playersList=d.players; renderCoopPlayers(); });
    socket.on('playerLeft',   d=>{ playersList=d.players; renderCoopPlayers(); });
    // Duel events
    socket.on('duel:playerJoined',  d=>{ duelPlayers=d.players; renderWaitPlayers(); });
    socket.on('duel:playerLeft',    d=>{ duelPlayers=d.players; renderWaitPlayers(); onDuelPlayerLeft(d); });
    socket.on('duel:playerReady',   d=>{ duelPlayers=d.players; renderWaitPlayers(); });
    socket.on('duel:optionsUpdate', d=>{ if(!duelIsOwner){ duelOptions=d.options; renderOptsReadonly(); } });
    socket.on('duel:start',         d=>{ onDuelStart(d); });
    socket.on('duel:found',         d=>{ onDuelFound(d); });
    socket.on('duel:attacked',      d=>{ onDuelAttacked(d); });
    socket.on('duel:over',          d=>{ onDuelOver(d); });
  }catch(e){ setDot('sdot','stext','disconnected'); setDot('sdot2','stext2','disconnected'); }
}

function setDot(dotId, txtId, s){
  const dot=document.getElementById(dotId), txt=document.getElementById(txtId);
  if(!dot) return;
  dot.className='sdot '+s;
  txt.textContent = s==='connected'?'ConnectÃ©':s==='connecting'?'Connexion...':'DÃ©connectÃ©';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveServerUrl(){
  const url=document.getElementById('server-url').value.trim().replace(/\/$/,'');
  if(!url.startsWith('http')){ document.getElementById('setup-err').textContent='URL invalide'; return; }
  document.getElementById('setup-err').textContent='';
  serverUrl=url; localStorage.setItem(URL_KEY,url);
  connectSocket(url); showScreen('s-lobby');
}
function skipSetup(){ showScreen('s-lobby'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOLO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startSolo(){
  coopMode='solo'; myName='Vous'; coopStartTime=Date.now();
  resetCoopState(); launchGame();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COOP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function createCoopRoom(){
  if(!socket?.connected){ document.getElementById('coop-err').textContent='Serveur non connectÃ©'; return; }
  const name=document.getElementById('player-name').value.trim();
  if(!name){ document.getElementById('coop-err').textContent='Entrez votre pseudo'; return; }
  document.getElementById('coop-err').textContent='';
  coopMode='multi'; myName=name;
  socket.emit('createRoom',{name},res=>{
    if(!res.ok){ document.getElementById('coop-err').textContent=res.error||'Erreur'; return; }
    coopRoomCode=res.code; coopStartTime=res.startTime;
    location.hash=coopRoomCode;
    resetCoopState(); launchGame();
  });
}

function joinCoopRoom(){
  if(!socket?.connected){ document.getElementById('coop-err').textContent='Serveur non connectÃ©'; return; }
  const name=document.getElementById('player-name').value.trim();
  const code=document.getElementById('room-code-input').value.trim().toUpperCase();
  if(!name){ document.getElementById('coop-err').textContent='Entrez votre pseudo'; return; }
  if(code.length!==6){ document.getElementById('coop-err').textContent='Code invalide'; return; }
  document.getElementById('coop-err').textContent='';
  coopMode='multi'; myName=name; coopRoomCode=code;
  socket.emit('joinRoom',{name,code},res=>{
    if(!res.ok){ document.getElementById('coop-err').textContent=res.error||'Salle introuvable'; return; }
    coopRoomCode=res.code; coopStartTime=res.startTime;
    location.hash=coopRoomCode;
    resetCoopState();
    (res.found||[]).forEach(ev=>{ if(!foundIds.has(ev.champId)){ foundIds.add(ev.champId); events.push(ev); }});
    playersList=res.players||[];
    launchGame();
  });
}

function onRemoteFind(ev){
  if(foundIds.has(ev.champId)) return;
  foundIds.add(ev.champId); events.push(ev);
  revealCoopTile(ev.champId, ev.playerName, false);
  addFeedItem(ev); updateCoopUI();
  playersList=ev.players||playersList; renderCoopPlayers();
  if(foundIds.size===allChampions.length) setTimeout(showVictory, 600);
}

function resetCoopState(){ foundIds=new Set(); events=[]; playersList=[]; }

function launchGame(){
  clearInterval(timerIntvl);
  buildCoopGrid();
  events.forEach(ev=>revealCoopTile(ev.champId,ev.playerName,ev.playerId===mySocketId));
  updateCoopUI();
  document.getElementById('total-count').textContent=allChampions.length;
  if(coopMode==='multi'){
    document.getElementById('room-badge').classList.remove('hidden');
    document.getElementById('room-badge-code').textContent=coopRoomCode;
  } else {
    document.getElementById('room-badge').classList.add('hidden');
  }
  renderCoopPlayers();
  document.getElementById('victory').classList.remove('show');
  showScreen('s-game');
  timerIntvl=setInterval(tickCoopTimer,1000);
  document.getElementById('champ-input').focus();
}

function buildCoopGrid(){
  const grid=document.getElementById('champ-grid');
  grid.innerHTML='';
  allChampions.forEach(ch=>{
    const tile=document.createElement('div'); tile.className='ctile'; tile.id=`ct-${ch.id}`;
    const img=document.createElement('img'); img.src=`https://ddragon.leagueoflegends.com/cdn/${version}/img/champion/${ch.id}.png`; img.alt=''; img.loading='lazy';
    const ov=document.createElement('div'); ov.className='ctile-ov'; ov.innerHTML='<span class="ctile-q">?</span>';
    const nm=document.createElement('div'); nm.className='ctile-name'; nm.textContent=ch.name;
    const fi=document.createElement('div'); fi.className='ctile-finder'; fi.id=`cf-${ch.id}`;
    tile.append(img,ov,nm,fi); grid.appendChild(tile);
  });
}

function revealCoopTile(id,finder,byme){
  const t=document.getElementById(`ct-${id}`);
  if(!t||t.classList.contains('found')) return;
  t.classList.add('found'); if(byme) t.classList.add('byme');
  const fi=document.getElementById(`cf-${id}`);
  if(fi&&coopMode==='multi'){ fi.textContent=finder; if(byme) fi.classList.add('byme'); }
}

function addFeedItem(ev){
  const feed=document.getElementById('feed-list');
  const el=document.createElement('div'); el.className='fi';
  const e=Math.floor((ev.ts-coopStartTime)/1000);
  const t=`${String(Math.floor(e/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`;
  el.innerHTML=`<img class="fi-img" src="https://ddragon.leagueoflegends.com/cdn/${version}/img/champion/${ev.champId}.png" alt=""><div class="fi-txt">${coopMode==='multi'?`<span class="fi-player">${escH(ev.playerName)}</span><br>`:''}${escH(ev.champName)}</div><span class="fi-time">${t}</span>`;
  feed.insertBefore(el,feed.firstChild);
  while(feed.children.length>80) feed.removeChild(feed.lastChild);
}

function updateCoopUI(){
  const n=foundIds.size, tot=allChampions.length;
  document.getElementById('found-count').textContent=n;
  document.getElementById('prog-fill').style.width=(n/tot*100)+'%';
  document.getElementById('prog-txt').textContent=`${n} / ${tot} champions`;
}

function renderCoopPlayers(){
  const bar=document.getElementById('players-bar'); bar.innerHTML='';
  if(coopMode!=='multi') return;
  (playersList||[]).forEach(p=>{
    const pip=document.createElement('div'); pip.className='plpip';
    const dot=document.createElement('div'); dot.className='plpipdot '+(p.id===mySocketId?'me':'other');
    pip.append(dot,document.createTextNode(`${p.name} (${p.score})`));
    bar.appendChild(pip);
  });
}

function tickCoopTimer(){
  const e=Math.floor((Date.now()-coopStartTime)/1000);
  document.getElementById('timer-disp').textContent=`${String(Math.floor(e/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`;
}

function showVictory(){
  clearInterval(timerIntvl);
  const e=Math.floor((Date.now()-coopStartTime)/1000);
  document.getElementById('vic-time').textContent=`${String(Math.floor(e/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`;
  const sc={};
  events.forEach(ev=>{ if(!sc[ev.playerId]) sc[ev.playerId]={name:ev.playerName,n:0}; sc[ev.playerId].n++; });
  const sorted=Object.values(sc).sort((a,b)=>b.n-a.n);
  document.getElementById('vic-scores').innerHTML=sorted.map((s,i)=>`<div class="sc-row"><span class="sc-name">${i===0?'ğŸ† ':''}${escH(s.name)}</span><span class="sc-pts">${s.n} trouvÃ©s</span></div>`).join('');
  document.getElementById('victory').classList.add('show');
}

/* ANSWER (coop/solo) */
document.getElementById('champ-input').addEventListener('keydown', e=>{ if(e.key==='Enter'){e.preventDefault();submitAnswer();} });

function submitAnswer(){
  const val=document.getElementById('champ-input').value.trim();
  if(!val) return;
  document.getElementById('champ-input').value='';
  let matched=null, matchType=false;
  for(const ch of allChampions){ const r=fuzzyMatch(val,ch.name); if(r==='exact'||r==='fuzzy'){matched=ch;matchType=r;break;} if(r==='almost'&&!matched){matched=ch;matchType='almost';} }
  if(!matched){ flashC('fw'); fbk('Champion inconnu...','wrong'); return; }
  if(matchType==='almost'){ flashC('fa'); fbk(`Presque ! â†’ "${matched.name}"`, 'almost'); return; }
  if(foundIds.has(matched.id)){ flashC('fa'); fbk(`${matched.name} dÃ©jÃ  trouvÃ© !`,'almost'); return; }
  const ev={champId:matched.id,champName:matched.name,playerId:mySocketId||'solo',playerName:myName,ts:Date.now()};
  foundIds.add(matched.id); events.push(ev);
  revealCoopTile(matched.id,myName,true);
  addFeedItem(ev); flashC('fc'); fbk(`âœ“ ${matched.name} !`,'correct'); updateCoopUI();
  if(coopMode==='multi'&&socket?.connected) socket.emit('champFound',{champId:matched.id,champName:matched.name});
  if(foundIds.size===allChampions.length) setTimeout(showVictory,600);
}

let fbT=null;
function fbk(msg,type){
  const el=document.getElementById('inp-fb'); el.textContent=msg;
  el.style.color=type==='correct'?'var(--ok)':type==='almost'?'var(--warn)':'var(--bad)';
  clearTimeout(fbT); fbT=setTimeout(()=>el.textContent='',2200);
}
let flT=null;
function flashC(cls){
  const el=document.getElementById('champ-input');
  el.classList.remove('fc','fw','fa'); void el.offsetWidth;
  el.classList.add(cls); clearTimeout(flT); flT=setTimeout(()=>el.classList.remove(cls),650);
}

function copyCoopLink(){
  const url=`${location.origin}${location.pathname}#${coopRoomCode}`;
  navigator.clipboard.writeText(url).then(()=>toast('ğŸ”— Lien copiÃ© !')).catch(()=>toast(`Code : ${coopRoomCode}`));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DUEL â€” LOBBY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function createDuelRoom(){
  if(!socket?.connected){ document.getElementById('duel-err').textContent='Serveur non connectÃ©'; return; }
  const name=document.getElementById('duel-name').value.trim()||guestId;
  duelMyName=name; duelIsOwner=true; duelIsReady=false;
  socket.emit('duel:create',{name,options:duelOptions},res=>{
    if(!res.ok){ document.getElementById('duel-err').textContent=res.error||'Erreur'; return; }
    duelRoomCode=res.code; location.hash=duelRoomCode;
    duelPlayers=[{id:mySocketId,name,score:0,ready:false}];
    enterDuelWait();
  });
}

function joinDuelRoom(){
  if(!socket?.connected){ document.getElementById('duel-err').textContent='Serveur non connectÃ©'; return; }
  const name=document.getElementById('duel-name').value.trim()||guestId;
  const code=document.getElementById('duel-code-input').value.trim().toUpperCase();
  if(code.length!==6){ document.getElementById('duel-err').textContent='Code invalide (6 caractÃ¨res)'; return; }
  duelMyName=name; duelIsOwner=false; duelIsReady=false;
  socket.emit('duel:join',{name,code},res=>{
    if(!res.ok){ document.getElementById('duel-err').textContent=res.error||'Introuvable'; return; }
    duelRoomCode=res.code; location.hash=duelRoomCode;
    duelOptions=res.options||duelOptions;
    duelPlayers=res.players||[];
    enterDuelWait();
  });
}

function enterDuelWait(){
  document.getElementById('dw-code').textContent=duelRoomCode;
  renderWaitPlayers();
  if(duelIsOwner){
    document.getElementById('dw-opts').classList.remove('hidden');
    document.getElementById('dw-opts-ro').classList.add('hidden');
    onOptsChange(); // init display
  } else {
    document.getElementById('dw-opts').classList.add('hidden');
    document.getElementById('dw-opts-ro').classList.remove('hidden');
    renderOptsReadonly();
  }
  autoReadySecs=30;
  document.getElementById('dw-auto-v').textContent=autoReadySecs;
  clearInterval(autoReadyTimer);
  autoReadyTimer=setInterval(()=>{
    autoReadySecs=Math.max(0,autoReadySecs-1);
    document.getElementById('dw-auto-v').textContent=autoReadySecs;
    if(autoReadySecs<=0) clearInterval(autoReadyTimer);
  },1000);
  showScreen('s-duel-wait');
}

function onOptsChange(){
  const dur=parseInt(document.getElementById('opt-dur').value);
  const cnt=parseInt(document.getElementById('opt-cnt').value);
  const atk=document.getElementById('opt-atk').checked;
  const atkt=parseInt(document.getElementById('opt-atkt').value);
  document.getElementById('ov-dur').textContent=`${dur} min`;
  document.getElementById('ov-cnt').textContent=cnt;
  document.getElementById('ov-atkt').textContent=atkt;
  document.getElementById('sub-atk').classList.toggle('hidden',!atk);
  duelOptions={duration:dur,champCount:cnt,attackMode:atk,atkThreshold:atkt};
  if(socket?.connected && duelIsOwner) socket.emit('duel:updateOptions',{code:duelRoomCode,options:duelOptions});
}

function renderOptsReadonly(){
  const o=duelOptions;
  document.getElementById('dw-opts-ro').innerHTML=
    `âš™ Options : ${o.duration} min Â· ${o.champCount} champions Ã  trouver${o.attackMode?` Â· Mode Attaque (seuil: ${o.atkThreshold})`:''}`;
}

function renderWaitPlayers(){
  document.getElementById('dw-players').innerHTML=duelPlayers.map(p=>`
    <div class="wp-row">
      <span class="wp-name${p.id===mySocketId?' me':''}">${escH(p.name)}</span>
      <span class="wp-badge ${p.ready?'ready':'waiting'}">${p.ready?'âœ“ PrÃªt':'En attente'}</span>
    </div>`).join('');
}

function setDuelReady(){
  if(duelIsReady) return;
  duelIsReady=true;
  const btn=document.getElementById('dw-ready-btn');
  btn.disabled=true; btn.textContent='âœ“ PrÃªt !';
  socket.emit('duel:ready');
}

function copyDuelLink(){
  const url=`${location.origin}${location.pathname}#${duelRoomCode}`;
  navigator.clipboard.writeText(url).then(()=>{
    const b=document.getElementById('dw-copy-btn');
    b.textContent='âœ… CopiÃ©'; setTimeout(()=>b.textContent='ğŸ“‹ Copier',1800);
  }).catch(()=>{});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DUEL â€” GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function onDuelStart(data){
  clearInterval(autoReadyTimer);
  duelOptions=data.options;
  duelAtkMode=duelOptions.attackMode;
  duelAtkThreshold=duelOptions.atkThreshold;
  duelChampCount=duelOptions.champCount;
  duelEndTime=Date.now()+duelOptions.duration*60*1000;

  myFoundSet=new Set(); oppFoundSet=new Set(); myStreak=0;

  const opp=data.players.find(p=>p.id!==mySocketId);
  duelOppName=opp?opp.name:'Adversaire'; duelOppId=opp?opp.id:'';

  document.getElementById('dph-me-name').textContent=duelMyName;
  document.getElementById('dph-opp-name').textContent=duelOppName;
  document.getElementById('dph-me-score').textContent='0';
  document.getElementById('dph-opp-score').textContent='0';
  document.getElementById('my-half-title').textContent=duelMyName;
  document.getElementById('opp-half-title').textContent=duelOppName;
  document.getElementById('my-half-score').textContent=`0 / ${duelChampCount}`;
  document.getElementById('opp-half-score').textContent=`0 / ${duelChampCount}`;
  document.getElementById('duel-cnt').textContent=`0 / ${duelChampCount}`;

  // Attack bar
  if(duelAtkMode){ document.getElementById('atk-wrap').style.display='flex'; renderAtkPips(0); }
  else document.getElementById('atk-wrap').style.display='none';

  buildDuelGrids();
  showScreen('s-duel');
  startDuelTimer();
  document.getElementById('duel-input').focus();
}

function buildDuelGrids(){
  const mg=document.getElementById('my-grid'), og=document.getElementById('opp-grid');
  mg.innerHTML=''; og.innerHTML='';
  allChampions.forEach(c=>{
    mg.appendChild(makeDtile(c,'m'));
    og.appendChild(makeDtile(c,'o'));
  });
}

function makeDtile(champ,prefix){
  const tile=document.createElement('div');
  tile.className='dtile'; tile.id=`${prefix}t-${champ.id}`;
  const img=document.createElement('img');
  img.src=`https://ddragon.leagueoflegends.com/cdn/${version}/img/champion/${champ.id}.png`;
  img.alt=champ.name; img.loading='lazy';
  const q=document.createElement('div'); q.className='dq'; q.textContent='?';
  tile.append(img,q); return tile;
}

function revealDtile(id,prefix){
  const t=document.getElementById(`${prefix}t-${id}`);
  if(t) t.classList.add('found');
}
function hideDtile(id){
  const t=document.getElementById(`mt-${id}`);
  if(t){ t.classList.remove('found'); t.classList.add('attacked'); setTimeout(()=>t.classList.remove('attacked'),800); }
}

function renderAtkPips(streak){
  const c=document.getElementById('atk-pips'); c.innerHTML='';
  for(let i=0;i<duelAtkThreshold;i++){
    const p=document.createElement('div');
    p.className='atk-pip'+(i<streak?' lit':'');
    c.appendChild(p);
  }
}

function startDuelTimer(){
  clearInterval(duelTimerInterval);
  duelTimerInterval=setInterval(()=>{
    const left=Math.max(0,duelEndTime-Date.now());
    const mins=Math.floor(left/60000), secs=Math.floor((left%60000)/1000);
    const el=document.getElementById('duel-timer');
    el.textContent=`${mins}:${String(secs).padStart(2,'0')}`;
    el.className='duel-timer'+(left<30000?' danger':'');
    if(left<=0) clearInterval(duelTimerInterval);
  },500);
}

/* Duel input */
const dInp=document.getElementById('duel-input');
const dDrop=document.getElementById('duel-drop');

dInp.addEventListener('input',()=>{
  duelSelAuto=-1;
  const q=nb(dInp.value);
  if(!q||q.length<1){ dDrop.classList.remove('open'); return; }
  const matches=allChampions
    .filter(c=>!myFoundSet.has(c.id)&&(nb(c.name).startsWith(q)||nb(c.name).includes(q)))
    .sort((a,b)=>nb(a.name).startsWith(q)?-1:1).slice(0,8);
  if(!matches.length){ dDrop.classList.remove('open'); return; }
  dDrop.innerHTML=matches.map(c=>`<div class="dauto-item" data-name="${escH(c.name)}" onclick="pickDuelAuto('${escH(c.name)}')">${hlMatch(c.name,dInp.value)}</div>`).join('');
  dDrop.classList.add('open');
});

dInp.addEventListener('keydown',e=>{
  const items=dDrop.querySelectorAll('.dauto-item');
  if(e.key==='ArrowDown'){duelSelAuto=Math.min(duelSelAuto+1,items.length-1);markDuelSel(items);e.preventDefault();}
  else if(e.key==='ArrowUp'){duelSelAuto=Math.max(duelSelAuto-1,0);markDuelSel(items);e.preventDefault();}
  else if(e.key==='Enter'){e.preventDefault();if(items.length&&duelSelAuto>=0)pickDuelAuto(items[duelSelAuto].dataset.name);else if(items.length)pickDuelAuto(items[0].dataset.name);else duelSubmit();}
});
document.addEventListener('click',e=>{ if(!e.target.closest('.duel-inp-wrap')) dDrop.classList.remove('open'); });

function markDuelSel(items){
  items.forEach((it,i)=>it.classList.toggle('sel',i===duelSelAuto));
  if(duelSelAuto>=0) dInp.value=items[duelSelAuto].dataset.name;
}
function pickDuelAuto(name){
  dInp.value=name; dDrop.classList.remove('open'); duelSelAuto=-1; duelSubmit();
}

function duelSubmit(){
  const val=dInp.value.trim(); if(!val) return;
  dInp.value=''; dDrop.classList.remove('open');

  // Fuzzy match
  let matched=null;
  for(const ch of allChampions){
    const r=fuzzyMatch(val,ch.name);
    if(r==='exact'||r==='fuzzy'){matched=ch;break;}
  }
  if(!matched||myFoundSet.has(matched.id)){
    dInp.className='duel-input dfw'; setTimeout(()=>dInp.className='duel-input',450); return;
  }

  // Correct
  dInp.className='duel-input dfc'; setTimeout(()=>dInp.className='duel-input',500);
  myFoundSet.add(matched.id); myStreak++;
  revealDtile(matched.id,'m');
  updateDuelMyScore();
  socket.emit('duel:found',{champId:matched.id});

  // Attack check (client confirms streak, server enforces)
  if(duelAtkMode) renderAtkPips(myStreak%duelAtkThreshold===0&&myStreak>0?0:myStreak%duelAtkThreshold);

  if(myFoundSet.size>=duelChampCount){
    // server will send over
  }
}

function updateDuelMyScore(){
  document.getElementById('dph-me-score').textContent=myFoundSet.size;
  document.getElementById('my-half-score').textContent=`${myFoundSet.size} / ${duelChampCount}`;
  document.getElementById('duel-cnt').textContent=`${myFoundSet.size} / ${duelChampCount}`;
}

function onDuelFound(data){
  if(data.playerId===mySocketId){
    // Reset opponent streak tracking
    // already handled locally
    return;
  }
  // Opponent found a champion â†’ reset my streak
  myStreak=0;
  if(duelAtkMode) renderAtkPips(0);

  oppFoundSet.add(data.champId);
  revealDtile(data.champId,'o');
  document.getElementById('dph-opp-score').textContent=oppFoundSet.size;
  document.getElementById('opp-half-score').textContent=`${oppFoundSet.size} / ${duelChampCount}`;
}

function onDuelAttacked(data){
  if(data.targetId!==mySocketId) return;
  const champId=data.victimId;
  if(myFoundSet.has(champId)){
    myFoundSet.delete(champId);
    hideDtile(champId);
    myStreak=0;
    if(duelAtkMode) renderAtkPips(0);
    updateDuelMyScore();
    const notif=document.getElementById('atk-notif');
    notif.classList.add('show'); setTimeout(()=>notif.classList.remove('show'),2000);
  }
}

function onDuelPlayerLeft(data){
  // If in game and opponent left â†’ auto win
  if(document.getElementById('s-duel').classList.contains('active')){
    clearInterval(duelTimerInterval);
    const scores={};
    scores[mySocketId]=myFoundSet.size;
    onDuelOver({winner:mySocketId,scores,reason:'disconnect'});
  }
}

function onDuelOver(data){
  clearInterval(duelTimerInterval);
  const myScore=data.scores?.[mySocketId]??myFoundSet.size;
  const oppScore=data.scores?.[duelOppId]??oppFoundSet.size;
  const winner=data.winner;
  const reason=data.reason;

  document.getElementById('res-title').textContent=
    reason==='disconnect'?'ğŸ† Victoire par forfait':
    !winner?'ğŸ¤ Ã‰galitÃ©':
    winner===mySocketId?'ğŸ† Victoire !':'ğŸ’€ DÃ©faite';
  document.getElementById('res-sub').textContent=
    `${duelOptions.duration} min Â· ${duelOptions.champCount} champions${duelAtkMode?' Â· Mode Attaque':''}`;

  document.getElementById('res-scores').innerHTML=`
    <div class="rsi ${winner===mySocketId?'winner':''}">
      <span class="rsi-val">${myScore}</span>
      <span class="rsi-name">${escH(duelMyName)} (vous)</span>
      <span class="rsi-pts">champions trouvÃ©s</span>
    </div>
    <div class="rsi ${winner===duelOppId?'winner':''}">
      <span class="rsi-val">${oppScore}</span>
      <span class="rsi-name">${escH(duelOppName)}</span>
      <span class="rsi-pts">champions trouvÃ©s</span>
    </div>`;
  showScreen('s-duel-result');
}

function replayDuel(){
  duelIsReady=false;
  const btn=document.getElementById('dw-ready-btn');
  btn.disabled=false; btn.textContent='âœ¦ Je suis prÃªt !';
  myFoundSet=new Set(); oppFoundSet=new Set(); myStreak=0;
  duelPlayers=duelPlayers.map(p=>({...p,ready:false,score:0}));
  renderWaitPlayers();
  socket.emit('duel:rejoin',{code:duelRoomCode});
  showScreen('s-duel-wait');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goLobby(){
  clearInterval(timerIntvl); clearInterval(duelTimerInterval);
  location.hash='';
  showScreen('s-lobby');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function hideLoading(){ document.getElementById('loading').classList.add('hidden'); }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),3000); }
function escH(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;'); }
function hlMatch(name,q){ return name.replace(new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<strong>$1</strong>'); }

document.getElementById('player-name').addEventListener('keydown',e=>{ if(e.key==='Enter') createCoopRoom(); });
document.getElementById('room-code-input').addEventListener('keydown',e=>{ if(e.key==='Enter') joinCoopRoom(); });
document.getElementById('server-url').addEventListener('keydown',e=>{ if(e.key==='Enter') saveServerUrl(); });
document.getElementById('duel-code-input').addEventListener('keydown',e=>{ if(e.key==='Enter') joinDuelRoom(); });
</script>
</body>
</html>
