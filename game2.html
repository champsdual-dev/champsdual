<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flou Chrono ‚Äî LoL</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
  :root{--gold:#C8AA6E;--gold-light:#F0E6D3;--gold-dark:#785A28;--deep:#010A13;--correct:#2ecc71;--wrong:#e74c3c;}
  body{background:var(--deep);color:var(--gold-light);font-family:'Cinzel',serif;min-height:100vh;overflow-x:hidden;}
  .bg-layer{position:fixed;inset:0;z-index:0;}
  .bg-gradient{background:radial-gradient(ellipse 80% 60% at 50% 30%,#0d1f3c 0%,transparent 70%),var(--deep);}
  .bg-hexgrid{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='70'%3E%3Cpolygon points='30,2 58,17 58,52 30,67 2,52 2,17' fill='none' stroke='%23C8AA6E' stroke-width='0.3' opacity='0.08'/%3E%3C/svg%3E");background-size:60px 70px;}
  .corner{position:fixed;width:80px;height:80px;z-index:2;opacity:.4;}
  .corner-tl{top:0;left:0;border-top:2px solid var(--gold);border-left:2px solid var(--gold);}
  .corner-tr{top:0;right:0;border-top:2px solid var(--gold);border-right:2px solid var(--gold);}
  .corner-bl{bottom:0;left:0;border-bottom:2px solid var(--gold);border-left:2px solid var(--gold);}
  .corner-br{bottom:0;right:0;border-bottom:2px solid var(--gold);border-right:2px solid var(--gold);}
  .header{position:relative;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:1.2rem 2rem;border-bottom:1px solid rgba(200,170,110,.2);}
  .back-btn{font-size:.65rem;letter-spacing:.25em;color:var(--gold);opacity:.6;text-decoration:none;text-transform:uppercase;transition:opacity .2s;cursor:pointer;background:none;border:none;font-family:'Cinzel',serif;}
  .back-btn:hover{opacity:1;}
  .header-title{font-family:'Cinzel Decorative',serif;font-size:clamp(.75rem,2vw,1rem);background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:.1em;}
  .score-wrap{display:flex;gap:1.5rem;align-items:center;}
  .score-item{text-align:center;}
  .score-label{font-size:.5rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.5;display:block;}
  .score-value{font-size:1.2rem;color:var(--gold-light);font-weight:600;}
  .game-area{position:relative;z-index:10;max-width:720px;margin:0 auto;padding:2rem 1.5rem 3rem;display:flex;flex-direction:column;align-items:center;gap:1.5rem;}

  /* ‚îÄ‚îÄ Top row: points + grace counter side by side ‚îÄ‚îÄ */
  .top-row{display:flex;align-items:center;justify-content:center;gap:1.5rem;}
  .points-block{text-align:center;}
  .points-display{font-family:'Cinzel Decorative',serif;font-size:clamp(2rem,8vw,3.5rem);background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 15px rgba(200,170,110,.5));line-height:1;transition:filter .3s;}
  .points-label{font-size:.55rem;letter-spacing:.35em;text-transform:uppercase;color:var(--gold);opacity:.5;margin-top:.25rem;}

  /* Grace block ‚Äî shown during 3s grace, hidden during play */
  .grace-block{display:flex;flex-direction:column;align-items:center;gap:.1rem;opacity:0;transform:scale(.8);transition:opacity .25s,transform .25s;}
  .grace-block.visible{opacity:1;transform:scale(1);}
  .grace-sep{font-size:1.5rem;color:var(--gold-dark);line-height:1;margin-right:.25rem;align-self:center;}
  .grace-inner{display:flex;align-items:center;gap:.4rem;}
  .grace-num{font-family:'Cinzel Decorative',serif;font-size:clamp(2rem,6vw,3rem);color:var(--gold);filter:drop-shadow(0 0 10px rgba(200,170,110,.8));line-height:1;}
  .grace-label{font-size:.45rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.6;margin-top:.15rem;}
  .grace-sublabel{font-size:.45rem;letter-spacing:.25em;text-transform:uppercase;color:var(--gold);opacity:.5;}

  /* Timer bar */
  .timer-wrap{width:min(600px,90vw);}
  .timer-bar-bg{width:100%;height:4px;background:rgba(200,170,110,.15);overflow:hidden;}
  .timer-bar{height:100%;background:linear-gradient(to right,var(--gold-dark),var(--gold),#F0E6D3);width:100%;transition:width .1s linear;}
  .timer-markers{display:flex;justify-content:space-between;margin-top:.4rem;}
  .timer-marker{font-size:.45rem;letter-spacing:.2em;color:var(--gold);opacity:.4;text-transform:uppercase;}

  /* Artwork */
  .artwork-frame{position:relative;width:min(600px,90vw);aspect-ratio:16/9;border:1px solid var(--gold-dark);overflow:hidden;background:#000;}
  .artwork-frame::before,.artwork-frame::after{content:'';position:absolute;width:20px;height:20px;z-index:5;border-color:var(--gold);border-style:solid;}
  .artwork-frame::before{top:-1px;left:-1px;border-width:2px 0 0 2px;}
  .artwork-frame::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0;}
  /* Image stays invisible until loaded blurred, then snaps to visible ‚Äî no brightness reduction */
  .artwork-img{width:100%;height:100%;object-fit:cover;object-position:center top;display:block;opacity:0;transition:opacity .05s;}
  .artwork-img.ready{opacity:1;}
  .reveal-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:4;pointer-events:none;opacity:0;transition:opacity .4s;}
  .reveal-overlay.show{opacity:1;}
  .reveal-name{font-family:'Cinzel Decorative',serif;font-size:clamp(1.5rem,5vw,3rem);text-align:center;padding:.5rem 2rem;background:rgba(1,10,19,.75);border:1px solid var(--gold-dark);background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}

  .blur-badge{font-size:.55rem;letter-spacing:.3em;text-transform:uppercase;color:var(--gold);opacity:.5;}

  /* Input */
  .input-area{width:min(600px,90vw);display:flex;flex-direction:column;gap:.75rem;}
  .input-wrap{position:relative;}
  .champ-input{width:100%;padding:.9rem 1.25rem;background:rgba(10,22,40,.9);border:1px solid var(--gold-dark);color:var(--gold-light);font-family:'Cinzel',serif;font-size:.85rem;letter-spacing:.1em;outline:none;transition:border-color .2s;}
  .champ-input:focus{border-color:var(--gold);}
  .champ-input::placeholder{color:rgba(200,170,110,.3);}
  .champ-input:disabled{opacity:.4;}
  .autocomplete{position:absolute;top:100%;left:0;right:0;z-index:20;background:rgba(5,15,30,.97);border:1px solid var(--gold-dark);border-top:none;max-height:200px;overflow-y:auto;display:none;}
  .autocomplete.open{display:block;}
  .auto-item{padding:.6rem 1.25rem;font-size:.8rem;letter-spacing:.08em;color:var(--gold-light);cursor:pointer;transition:background .15s;}
  .auto-item:hover,.auto-item.selected{background:rgba(200,170,110,.15);}
  .auto-item strong{color:var(--gold);}
  .submit-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;width:100%;padding:.9rem;background:transparent;border:none;cursor:pointer;font-family:'Cinzel',serif;font-size:.8rem;font-weight:600;letter-spacing:.25em;text-transform:uppercase;color:var(--deep);clip-path:polygon(12px 0%,calc(100% - 12px) 0%,100% 50%,calc(100% - 12px) 100%,12px 100%,0% 50%);transition:transform .2s,filter .2s;}
  .submit-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,#F0E6D3 0%,#C8AA6E 50%,#A17D3A 100%);z-index:-1;}
  .submit-btn:hover:not(:disabled){transform:scale(1.02);filter:brightness(1.1);}
  .submit-btn:disabled{opacity:.4;cursor:not-allowed;}
  .feedback{text-align:center;min-height:1.5rem;}
  .feedback-text{font-size:.75rem;letter-spacing:.2em;text-transform:uppercase;}
  .feedback-text.correct{color:var(--correct);}
  .feedback-text.wrong{color:var(--wrong);}
  .next-btn{position:relative;display:inline-flex;align-items:center;gap:.75rem;padding:.9rem 3rem;background:transparent;border:none;cursor:pointer;font-family:'Cinzel',serif;font-size:.8rem;font-weight:600;letter-spacing:.25em;text-transform:uppercase;color:var(--deep);transition:transform .2s,opacity .3s;opacity:0;pointer-events:none;clip-path:polygon(12px 0%,calc(100% - 12px) 0%,100% 50%,calc(100% - 12px) 100%,12px 100%,0% 50%);}
  .next-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,#F0E6D3 0%,#C8AA6E 50%,#A17D3A 100%);z-index:-1;}
  .next-btn.visible{opacity:1;pointer-events:all;}
  .next-btn:hover{transform:scale(1.04);filter:brightness(1.1);}
  .enter-hint{font-size:.5rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold);opacity:0;transition:opacity .3s;}
  .enter-hint.visible{opacity:.4;}
  .loading{position:fixed;inset:0;z-index:50;background:var(--deep);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.5rem;transition:opacity .6s ease;}
  .loading.hidden{opacity:0;pointer-events:none;}
  .loading-title{font-family:'Cinzel Decorative',serif;font-size:1.5rem;background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
  .loading-bar-wrap{width:200px;height:2px;background:rgba(200,170,110,.2);overflow:hidden;}
  .loading-bar{width:100%;height:100%;background:linear-gradient(to right,transparent,var(--gold),transparent);animation:scan 1.2s ease-in-out infinite;}
  @keyframes scan{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
  .loading-text{font-size:.6rem;letter-spacing:.3em;color:var(--gold);opacity:.5;text-transform:uppercase;}
  .gameover{position:fixed;inset:0;z-index:40;background:rgba(1,10,19,.97);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .5s ease;}
  .gameover.show{opacity:1;pointer-events:all;}
  .gameover-box{text-align:center;border:1px solid var(--gold-dark);padding:3rem 4rem;background:linear-gradient(135deg,#0a1628,#010a13);position:relative;max-width:480px;width:90%;}
  .gameover-box::before{content:'';position:absolute;top:-2px;left:-2px;width:25px;height:25px;border:2px solid var(--gold);border-right:none;border-bottom:none;}
  .gameover-box::after{content:'';position:absolute;bottom:-2px;right:-2px;width:25px;height:25px;border:2px solid var(--gold);border-left:none;border-top:none;}
  .gameover-title{font-family:'Cinzel Decorative',serif;font-size:1.8rem;background:linear-gradient(180deg,#F0E6D3 0%,#C8AA6E 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:.5rem;}
  .gameover-sub{font-size:.6rem;letter-spacing:.3em;color:var(--gold);opacity:.6;text-transform:uppercase;margin-bottom:2rem;}
  .gameover-score{font-size:3.5rem;color:var(--gold);font-weight:600;margin-bottom:.25rem;}
  .gameover-max{font-size:.65rem;letter-spacing:.25em;color:var(--gold);opacity:.5;margin-bottom:2.5rem;}
  .rank-label{font-size:.7rem;letter-spacing:.2em;color:var(--gold);margin-bottom:2rem;}
  .restart-btn{position:relative;display:inline-flex;align-items:center;gap:.75rem;padding:.9rem 3rem;background:transparent;border:none;cursor:pointer;font-family:'Cinzel',serif;font-size:.8rem;letter-spacing:.25em;text-transform:uppercase;color:var(--deep);clip-path:polygon(12px 0%,calc(100% - 12px) 0%,100% 50%,calc(100% - 12px) 100%,12px 100%,0% 50%);transition:transform .2s,filter .2s;}
  .restart-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,#F0E6D3 0%,#C8AA6E 50%,#A17D3A 100%);z-index:-1;}
  .restart-btn:hover{transform:scale(1.04);filter:brightness(1.1);}
</style>
</head>
<body>
<div class="bg-layer bg-gradient"></div>
<div class="bg-layer bg-hexgrid"></div>
<div class="corner corner-tl"></div><div class="corner corner-tr"></div>
<div class="corner corner-bl"></div><div class="corner corner-br"></div>
<div class="loading" id="loading">
  <div class="loading-title">Convocation...</div>
  <div class="loading-bar-wrap"><div class="loading-bar"></div></div>
  <div class="loading-text">Chargement des champions</div>
</div>
<div class="gameover" id="gameover">
  <div class="gameover-box">
    <div class="gameover-title">Partie Termin√©e</div>
    <div class="gameover-sub">Score final ‚Äî Flou Chrono</div>
    <div class="gameover-score" id="final-score">0</div>
    <div class="gameover-max" id="final-max">/ 1000 pts max</div>
    <div class="rank-label" id="rank-label"></div>
    <button class="restart-btn" onclick="restartGame()">Rejouer</button>
  </div>
</div>
<header class="header">
  <a class="back-btn" href="index.html">‚Üê Accueil</a>
  <div class="header-title">‚è±Ô∏è Flou Chrono</div>
  <div class="score-wrap">
    <div class="score-item"><span class="score-label">Score</span><span class="score-value" id="score-display">0</span></div>
    <div class="score-item"><span class="score-label">Round</span><span class="score-value" id="round-display">1/10</span></div>
  </div>
</header>
<div class="game-area">

  <!-- Points + Grace counter side by side -->
  <div class="top-row">
    <div class="points-block">
      <div class="points-display" id="points-now">100</div>
      <div class="points-label">points disponibles</div>
    </div>
    <!-- Grace block: "  + 3 sec bonus" -->
    <div class="grace-block" id="grace-block">
      <div class="grace-inner">
        <div class="grace-sep">+</div>
        <div>
          <div class="grace-num" id="grace-num">3</div>
        </div>
      </div>
      <div class="grace-sublabel">sec bonus</div>
    </div>
  </div>

  <div class="timer-wrap">
    <div class="timer-bar-bg"><div class="timer-bar" id="timer-bar"></div></div>
    <div class="timer-markers">
      <span class="timer-marker">Max pts</span>
      <span class="timer-marker" id="blur-badge">Flou √ó28</span>
      <span class="timer-marker">0 pts</span>
    </div>
  </div>

  <!-- Artwork: no overlay on image during grace -->
  <div class="artwork-frame">
    <img class="artwork-img" id="artwork-img" src="" alt="">
    <div class="reveal-overlay" id="reveal-overlay">
      <div class="reveal-name" id="reveal-name"></div>
    </div>
  </div>

  <div class="input-area">
    <div class="input-wrap">
      <input class="champ-input" id="champ-input" type="text" placeholder="Entrez le nom du champion..." autocomplete="off">
      <div class="autocomplete" id="autocomplete"></div>
    </div>
    <button class="submit-btn" id="submit-btn" onclick="submitAnswer()">Valider</button>
  </div>

  <div class="feedback" id="feedback"></div>
  <button class="next-btn" id="next-btn" onclick="nextRound()">Round suivant ‚Üí</button>
  <div class="enter-hint" id="enter-hint">‚Üµ Entr√©e pour continuer</div>
</div>

<script>
  const TOTAL_ROUNDS = 10;
  const MAX_BLUR     = 28;
  const GRACE_SECS   = 3;
  const PLAY_MS      = 20000;
  const TICK_MS      = 100;

  let allChampions = [], champNames = [], champQueue = [], version = '';
  let current = null;
  let roundNum = 1, totalScore = 0;
  let answered = false;
  let phase = 'idle'; // 'grace' | 'play' | 'done'
  let graceCount = GRACE_SECS;
  let playElapsed = 0;
  let timerInterval = null;
  let currentPoints = 100;
  let selectedAuto = -1;

  /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
  async function init() {
    try {
      const v = await fetch('https://ddragon.leagueoflegends.com/api/versions.json');
      version = (await v.json())[0];
      const r = await fetch(`https://ddragon.leagueoflegends.com/cdn/${version}/data/fr_FR/champion.json`);
      allChampions = Object.values((await r.json()).data);
      champNames   = allChampions.map(c => c.name);
      document.getElementById('loading').classList.add('hidden');
      buildQueue();
      loadRound();
    } catch(e) { document.querySelector('.loading-text').textContent = 'Erreur r√©seau'; }
  }

  function buildQueue() {
    champQueue = [...allChampions].sort(() => Math.random() - .5);
  }

  /* ‚îÄ‚îÄ Load round ‚îÄ‚îÄ */
  function loadRound() {
    answered = false;
    phase = 'idle';
    graceCount = GRACE_SECS;
    playElapsed = 0;
    currentPoints = 100;
    selectedAuto = -1;
    clearInterval(timerInterval);

    document.getElementById('feedback').innerHTML = '';
    document.getElementById('next-btn').classList.remove('visible');
    document.getElementById('enter-hint').classList.remove('visible');
    document.getElementById('reveal-overlay').classList.remove('show');
    document.getElementById('champ-input').value = '';
    document.getElementById('champ-input').disabled = true;
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('autocomplete').classList.remove('open');
    document.getElementById('round-display').textContent = `${roundNum}/10`;
    document.getElementById('timer-bar').style.transition = 'none';
    document.getElementById('timer-bar').style.width = '100%';
    updatePointsDisplay(100);

    /* Show grace block with countdown = 3 */
    document.getElementById('grace-num').textContent = GRACE_SECS;
    document.getElementById('grace-block').classList.add('visible');

    current = champQueue[roundNum - 1];

    /* Preload image invisible, MAX_BLUR applied BEFORE reveal ‚Äî NO brightness reduction */
    const img = document.getElementById('artwork-img');
    img.classList.remove('ready');
    img.style.transition = 'none';
    img.style.filter = `blur(${MAX_BLUR}px)`;   // ‚Üê blur only, no brightness change
    updateBlurBadge(MAX_BLUR);

    img.onload = () => {
      void img.offsetWidth; // reflow so blur is computed before display
      img.classList.add('ready'); // show image ‚Äî already blurred
      startGrace();
    };
    img.src = `https://ddragon.leagueoflegends.com/cdn/img/champion/splash/${current.id}_0.jpg`;
  }

  /* ‚îÄ‚îÄ Grace phase: countdown beside the points, 100 pts available ‚îÄ‚îÄ */
  function startGrace() {
    phase = 'grace';
    document.getElementById('champ-input').disabled = false;
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('champ-input').focus();

    timerInterval = setInterval(() => {
      if (answered) { clearInterval(timerInterval); return; }
      graceCount--;

      if (graceCount <= 0) {
        clearInterval(timerInterval);
        /* Hide grace counter */
        document.getElementById('grace-block').classList.remove('visible');
        /* Now allow smooth deblur */
        document.getElementById('artwork-img').style.transition = 'filter .2s linear';
        startPlay();
      } else {
        document.getElementById('grace-num').textContent = graceCount;
      }
    }, 1000);
  }

  /* ‚îÄ‚îÄ Play phase: 20s deblur, 100‚Üí0 pts ‚îÄ‚îÄ */
  function startPlay() {
    phase = 'play';
    timerInterval = setInterval(() => {
      if (answered) { clearInterval(timerInterval); return; }
      playElapsed += TICK_MS;
      const p = Math.min(playElapsed / PLAY_MS, 1);

      currentPoints = Math.max(0, Math.round(100 * (1 - p)));
      updatePointsDisplay(currentPoints);
      document.getElementById('timer-bar').style.transition = 'width .1s linear';
      document.getElementById('timer-bar').style.width = (100 * (1 - p)) + '%';

      const blurVal = Math.max(0, Math.round(MAX_BLUR * (1 - p)));
      document.getElementById('artwork-img').style.filter = `blur(${blurVal}px)`;
      updateBlurBadge(blurVal);

      if (p >= 1) { clearInterval(timerInterval); if (!answered) timeOut(); }
    }, TICK_MS);
  }

  function updateBlurBadge(v) {
    document.getElementById('blur-badge').textContent = v > 0 ? `Flou √ó${v}` : 'Net';
  }

  function updatePointsDisplay(pts) {
    const el = document.getElementById('points-now');
    el.textContent = pts;
    el.style.filter = pts > 60
      ? 'drop-shadow(0 0 15px rgba(200,170,110,.5))'
      : pts > 30
        ? 'drop-shadow(0 0 15px rgba(255,180,50,.6))'
        : 'drop-shadow(0 0 15px rgba(231,76,60,.7))';
  }

  function timeOut() {
    answered = true;
    document.getElementById('champ-input').disabled = true;
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('artwork-img').style.transition = 'filter .4s ease';
    document.getElementById('artwork-img').style.filter = 'blur(0)';
    document.getElementById('grace-block').classList.remove('visible');
    document.getElementById('reveal-name').textContent = current.name;
    document.getElementById('reveal-overlay').classList.add('show');
    document.getElementById('feedback').innerHTML = `<div class="feedback-text wrong">‚è± Temps √©coul√© ! C'√©tait ${current.name}</div>`;
    if (roundNum >= TOTAL_ROUNDS) setTimeout(showGameOver, 1500);
    else {
      document.getElementById('next-btn').classList.add('visible');
      document.getElementById('enter-hint').classList.add('visible');
    }
  }

  /* ‚îÄ‚îÄ Answer ‚îÄ‚îÄ */
  function submitAnswer() {
    if (answered) return;
    const val = document.getElementById('champ-input').value.trim();
    if (!val) return;
    /* If dropdown is open and no item selected, auto-select first item */
    const items = document.getElementById('autocomplete').querySelectorAll('.auto-item');
    if (document.getElementById('autocomplete').classList.contains('open') && items.length > 0 && selectedAuto === -1) {
      selectAuto(items[0].dataset.name);
      return;
    }
    checkAnswer(val);
  }

  function checkAnswer(val) {
    if (answered) return;
    clearInterval(timerInterval);
    answered = true;
    document.getElementById('champ-input').disabled = true;
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('autocomplete').classList.remove('open');
    document.getElementById('grace-block').classList.remove('visible');

    document.getElementById('artwork-img').style.transition = 'filter .4s ease';
    document.getElementById('artwork-img').style.filter = 'blur(0)';
    document.getElementById('reveal-name').textContent = current.name;
    document.getElementById('reveal-overlay').classList.add('show');

    const isCorrect = normalize(val) === normalize(current.name);
    if (isCorrect) {
      const pts = phase === 'grace' ? 100 : Math.max(5, currentPoints);
      totalScore += pts;
      document.getElementById('score-display').textContent = totalScore;
      document.getElementById('feedback').innerHTML = `<div class="feedback-text correct">‚úì Exact ! +${pts} points</div>`;
    } else {
      document.getElementById('feedback').innerHTML = `<div class="feedback-text wrong">‚úó C'√©tait ${current.name}</div>`;
    }

    if (roundNum >= TOTAL_ROUNDS) setTimeout(showGameOver, 1500);
    else {
      document.getElementById('next-btn').classList.add('visible');
      document.getElementById('enter-hint').classList.add('visible');
    }
  }

  function normalize(s) {
    return s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]/g,'');
  }

  /* ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ */
  function nextRound() {
    if (roundNum >= TOTAL_ROUNDS) { showGameOver(); return; }
    roundNum++;
    loadRound();
  }

  function showGameOver() {
    clearInterval(timerInterval);
    document.getElementById('final-score').textContent = totalScore;
    document.getElementById('final-max').textContent = `/ ${TOTAL_ROUNDS * 100} pts max`;
    const pct = totalScore / (TOTAL_ROUNDS * 100);
    const ranks = [[.9,'üëë Rang S+ ‚Äî R√©flexes de Challenger !'],[.7,'‚öîÔ∏è Rang A ‚Äî Diamant Invocateur'],[.5,'üõ°Ô∏è Rang B ‚Äî Platine Vaillant'],[.3,'üó°Ô∏è Rang C ‚Äî Or Apprenti'],[0,'üíÄ Rang D ‚Äî Entra√Ænez vos yeux...']];
    document.getElementById('rank-label').textContent = ranks.find(([t]) => pct >= t)[1];
    document.getElementById('gameover').classList.add('show');
  }

  function restartGame() {
    roundNum = 1; totalScore = 0; answered = false;
    document.getElementById('score-display').textContent = '0';
    document.getElementById('gameover').classList.remove('show');
    buildQueue();
    loadRound();
  }

  /* ‚îÄ‚îÄ Autocomplete ‚îÄ‚îÄ */
  const inputEl = document.getElementById('champ-input');
  const dropEl  = document.getElementById('autocomplete');

  inputEl.addEventListener('input', () => {
    selectedAuto = -1;
    const q = normalize(inputEl.value);
    if (!q || q.length < 2) { dropEl.classList.remove('open'); return; }
    const matches = champNames.filter(n => normalize(n).includes(q)).slice(0, 8);
    if (!matches.length) { dropEl.classList.remove('open'); return; }
    dropEl.innerHTML = matches.map(n =>
      `<div class="auto-item" data-name="${escHtml(n)}" onclick="selectAuto(${JSON.stringify(n)})">${highlight(n, inputEl.value)}</div>`
    ).join('');
    dropEl.classList.add('open');
  });

  inputEl.addEventListener('keydown', e => {
    const items = dropEl.querySelectorAll('.auto-item');
    if (e.key === 'ArrowDown') {
      selectedAuto = Math.min(selectedAuto + 1, items.length - 1);
      markSelected(items); e.preventDefault();
    } else if (e.key === 'ArrowUp') {
      selectedAuto = Math.max(selectedAuto - 1, 0);
      markSelected(items); e.preventDefault();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (answered) {
        /* After answering, Enter = next round */
        const nb = document.getElementById('next-btn');
        if (nb.classList.contains('visible')) nextRound();
        return;
      }
      if (items.length > 0) {
        /* Select the highlighted item, or the first item if none highlighted */
        const idx = selectedAuto >= 0 ? selectedAuto : 0;
        selectAuto(items[idx].dataset.name);
      } else {
        submitAnswer();
      }
    }
  });

  function markSelected(items) {
    items.forEach((it, i) => it.classList.toggle('selected', i === selectedAuto));
    if (selectedAuto >= 0) inputEl.value = items[selectedAuto].dataset.name;
  }

  function selectAuto(name) {
    inputEl.value = name;
    dropEl.classList.remove('open');
    selectedAuto = -1;
    checkAnswer(name);
  }

  function highlight(name, q) {
    return name.replace(new RegExp('(' + q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')', 'gi'), '<strong>$1</strong>');
  }
  function escHtml(s) { return s.replace(/"/g,'&quot;'); }

  document.addEventListener('click', e => { if (!e.target.closest('.input-wrap')) dropEl.classList.remove('open'); });

  /* Enter after answer = next round (when input not focused) */
  document.addEventListener('keydown', e => {
    if (e.key === 'Enter' && answered && document.activeElement !== inputEl) {
      const nb = document.getElementById('next-btn');
      if (nb.classList.contains('visible')) nextRound();
    }
  });

  init();
</script>
</body>
</html>
